<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>查询 | easysql</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="类型安全的查询构造器，orm">
    
    <link rel="preload" href="/easysql-doc/assets/css/0.styles.e413b544.css" as="style"><link rel="preload" href="/easysql-doc/assets/js/app.043c89df.js" as="script"><link rel="preload" href="/easysql-doc/assets/js/2.ebde4dba.js" as="script"><link rel="preload" href="/easysql-doc/assets/js/16.b981116c.js" as="script"><link rel="prefetch" href="/easysql-doc/assets/js/10.755206bb.js"><link rel="prefetch" href="/easysql-doc/assets/js/11.108365c7.js"><link rel="prefetch" href="/easysql-doc/assets/js/12.1019e624.js"><link rel="prefetch" href="/easysql-doc/assets/js/13.eaad68f3.js"><link rel="prefetch" href="/easysql-doc/assets/js/14.ebdb112e.js"><link rel="prefetch" href="/easysql-doc/assets/js/15.16c963a1.js"><link rel="prefetch" href="/easysql-doc/assets/js/17.8b6320d9.js"><link rel="prefetch" href="/easysql-doc/assets/js/3.8dfc125c.js"><link rel="prefetch" href="/easysql-doc/assets/js/4.13b745f6.js"><link rel="prefetch" href="/easysql-doc/assets/js/5.54501c54.js"><link rel="prefetch" href="/easysql-doc/assets/js/6.45f8a5ad.js"><link rel="prefetch" href="/easysql-doc/assets/js/7.4e2227f1.js"><link rel="prefetch" href="/easysql-doc/assets/js/8.fc49f0b8.js"><link rel="prefetch" href="/easysql-doc/assets/js/9.27ab6d13.js">
    <link rel="stylesheet" href="/easysql-doc/assets/css/0.styles.e413b544.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/easysql-doc/" class="home-link router-link-active"><!----> <span class="site-name">easysql</span></a> <div class="links"><!----> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/easysql-doc/" aria-current="page" class="sidebar-link">概述</a></li><li><a href="/easysql-doc/introduction/" class="sidebar-link">入门</a></li><li><a href="/easysql-doc/metadata/" class="sidebar-link">元数据配置</a></li><li><a href="/easysql-doc/expr/" class="sidebar-link">表达式</a></li><li><a href="/easysql-doc/select/" aria-current="page" class="active sidebar-link">查询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/easysql-doc/select/#select" class="sidebar-link">select</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/select/#from" class="sidebar-link">from</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/select/#where" class="sidebar-link">where</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/select/#order-by" class="sidebar-link">order by</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/select/#group-by与having" class="sidebar-link">group by与having</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/select/#distinct" class="sidebar-link">distinct</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/select/#limit" class="sidebar-link">limit</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/select/#join" class="sidebar-link">join</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/select/#子查询" class="sidebar-link">子查询</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/select/#for-update" class="sidebar-link">for update</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/select/#生成sql" class="sidebar-link">生成sql</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/select/#union查询" class="sidebar-link">union查询</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/select/#with查询" class="sidebar-link">with查询</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/select/#values临时表" class="sidebar-link">values临时表</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/select/#获取生成的语法树" class="sidebar-link">获取生成的语法树</a></li></ul></li><li><a href="/easysql-doc/query/" class="sidebar-link">集合函数风格查询</a></li><li><a href="/easysql-doc/jpa/" class="sidebar-link">JPA风格查询</a></li><li><a href="/easysql-doc/update/" class="sidebar-link">增删改</a></li><li><a href="/easysql-doc/native-sql/" class="sidebar-link">原生sql</a></li><li><a href="/easysql-doc/database/" class="sidebar-link">数据库交互</a></li><li><a href="/easysql-doc/nosql/" class="sidebar-link">nosql支持</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="查询"><a href="#查询" class="header-anchor">#</a> 查询</h1> <p>库内置了一系列中缀方法，来构建查询，比如：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user where user<span class="token punctuation">.</span>name <span class="token operator">==</span><span class="token operator">=</span> <span class="token string">&quot;x&quot;</span> orderBy user<span class="token punctuation">.</span>id<span class="token punctuation">.</span>asc
</code></pre></div><p>然后我们可以使用<code>sql</code>方法，传入数据库方言的枚举，来生成sql语句：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> sql<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> s<span class="token punctuation">.</span>sql<span class="token punctuation">(</span>DB<span class="token punctuation">.</span>MYSQL<span class="token punctuation">)</span>
</code></pre></div><p>如果不需要使用多种数据库，每次生成sql都要传入一个数据库类型，十分不方便，这个时候，我们可以创建一个<code>given</code>，然后使用<code>toSql</code>方法来生成sql。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>
<span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>database<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">given</span> DB <span class="token operator">=</span> DB<span class="token punctuation">.</span>MYSQL

<span class="token keyword">val</span> s1 <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span> from user
<span class="token keyword">val</span> sql1 <span class="token operator">=</span> s1<span class="token punctuation">.</span>toSql

<span class="token keyword">val</span> s2 <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user where user<span class="token punctuation">.</span>name <span class="token operator">==</span><span class="token operator">=</span> <span class="token string">&quot;x&quot;</span>
<span class="token keyword">val</span> sql2 <span class="token operator">=</span> s2<span class="token punctuation">.</span>toSql
</code></pre></div><h2 id="select"><a href="#select" class="header-anchor">#</a> select</h2> <p>使用select方法，传入若干表达式或使用asTable创建的表，来生成select子句：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token comment">// 后续的select方法调用，会把字段追加在后面</span>
<span class="token keyword">val</span> s <span class="token operator">=</span> select<span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span>select<span class="token punctuation">(</span>user<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre></div><p>表结构和表达式都可以传入select中，生成sql时会进行自动展开：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">,</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>select列表中的字段类型会在子查询等时机保证类型安全，并且在与数据库交互时自动推断结果类型，但要求你的查询字段是可以在编译期确定的。如果查询字段是运行期动态传入的，需要使用<code>dynamicSelect</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token comment">// 假设此处查询的列是用户传入参数</span>
<span class="token keyword">val</span> list <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;y&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;z&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// 把字符串列表转换为字段列表，并传入dynamicSelect中</span>
<span class="token keyword">val</span> s <span class="token operator">=</span> dynamicSelect<span class="token punctuation">(</span>list<span class="token punctuation">.</span>map<span class="token punctuation">(</span>col<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="from"><a href="#from" class="header-anchor">#</a> from</h2> <p>使用中缀方法<code>from</code>，并传入表结构：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user
</code></pre></div><p>如果你只需要构建简单的单表查询，select子句可以省略：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> from<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
</code></pre></div><p>如果你的表名也是运行期动态确定的，可以使用<code>table</code>方法：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">&quot;c1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> from table<span class="token punctuation">(</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>from方法也可以传入一个子查询，会在后续子查询部分进行说明。</p> <p>表可以起别名，我们可以用别名表来处理自连接：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> t1 <span class="token operator">=</span> user as <span class="token string">&quot;t1&quot;</span>
<span class="token keyword">val</span> t2 <span class="token operator">=</span> user as <span class="token string">&quot;t2&quot;</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>t1<span class="token punctuation">,</span> t2<span class="token punctuation">)</span> from t1 join t2 on t1<span class="token punctuation">.</span>id <span class="token operator">==</span><span class="token operator">=</span> t2<span class="token punctuation">.</span>id
</code></pre></div><p>如果别名是运行期确定，要使用<code>unsafeAs</code>方法。</p> <h2 id="where"><a href="#where" class="header-anchor">#</a> where</h2> <p>使用中缀方法<code>where</code>配合表达式来生成查询条件：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user where user<span class="token punctuation">.</span>id <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> user<span class="token punctuation">.</span>name <span class="token operator">==</span><span class="token operator">=</span> <span class="token string">&quot;x&quot;</span>
</code></pre></div><p>如果你的查询条件都是使用<code>AND</code>来连接，那么也可以选择使用多个<code>where</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user

<span class="token keyword">val</span> sWhere <span class="token operator">=</span> s<span class="token punctuation">.</span>where<span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">.</span>in<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>user<span class="token punctuation">.</span>name <span class="token operator">==</span><span class="token operator">=</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>某些需要视情况而动态拼接的查询条件，可以在<code>where</code>中传入一个Boolean值或者返回Boolean的函数：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> name<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user
<span class="token keyword">val</span> sWhere <span class="token operator">=</span> s<span class="token punctuation">.</span>where<span class="token punctuation">(</span>name<span class="token punctuation">.</span>nonEmpty<span class="token punctuation">,</span> user<span class="token punctuation">.</span>name <span class="token operator">==</span><span class="token operator">=</span> name<span class="token punctuation">)</span>
</code></pre></div><h2 id="order-by"><a href="#order-by" class="header-anchor">#</a> order by</h2> <p>表达式类型中，有<code>asc</code>、<code>desc</code>两个方法，用来配合<code>orderBy</code>创建排序规则：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user orderBy <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">.</span>asc<span class="token punctuation">,</span> user<span class="token punctuation">.</span>name<span class="token punctuation">.</span>desc<span class="token punctuation">)</span>
</code></pre></div><h2 id="group-by与having"><a href="#group-by与having" class="header-anchor">#</a> group by与having</h2> <p>使用<code>groupBy</code>做数据分组，<code>having</code>做分组后的筛选：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>name<span class="token punctuation">,</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> from user groupBy user<span class="token punctuation">.</span>name having count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span>
</code></pre></div><p>除了普通的group by之外，还支持几个特殊的group by形式：</p> <ol><li><code>rollup</code>：<div class="language-scala extra-class"><pre class="language-scala"><code>select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user<span class="token punctuation">.</span>name<span class="token punctuation">,</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> from user groupBy rollup<span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre></div></li> <li><code>cube</code>：<div class="language-scala extra-class"><pre class="language-scala"><code>select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user<span class="token punctuation">.</span>name<span class="token punctuation">,</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> from user groupBy cube<span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre></div></li> <li><code>groupingSets</code>（参数类型支持表达式、表达式元组以及Unit）:<div class="language-scala extra-class"><pre class="language-scala"><code>select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user<span class="token punctuation">.</span>name<span class="token punctuation">,</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> from user groupBy groupingSets<span class="token punctuation">(</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></li></ol> <p>上面的各种group by形式可以组合调用。</p> <h2 id="distinct"><a href="#distinct" class="header-anchor">#</a> distinct</h2> <p>使用<code>distinct</code>做数据去重：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select<span class="token punctuation">(</span>user<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>from<span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>distinct
</code></pre></div><h2 id="limit"><a href="#limit" class="header-anchor">#</a> limit</h2> <p>使用limit和offset两个方法，来限制结果集：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user limit <span class="token number">10</span> offset <span class="token number">100</span>
</code></pre></div><p>当只调用其中一个方法的时候，limit的缺省值为1，offset的缺省值为0。</p> <blockquote><p>生成sql时会根据方言的不同生成不同的语句</p></blockquote> <h2 id="join"><a href="#join" class="header-anchor">#</a> join</h2> <p>内置了<code>join</code>、<code>leftJoin</code>、<code>rightJoin</code>、<code>innerJoin</code>、<code>fullJoin</code>、<code>crossJoin</code>方法，配合<code>on</code>方法来连接表：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> from a join b on a<span class="token punctuation">.</span>x <span class="token operator">==</span><span class="token operator">=</span> b<span class="token punctuation">.</span>y
</code></pre></div><p>可以像真正的sql一样，使用小括号来限制表连接的顺序：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span> from a join <span class="token punctuation">(</span>b leftJoin c on b<span class="token punctuation">.</span>y <span class="token operator">==</span><span class="token operator">=</span> c<span class="token punctuation">.</span>z<span class="token punctuation">)</span> on a<span class="token punctuation">.</span>x <span class="token operator">==</span><span class="token operator">=</span> b<span class="token punctuation">.</span>y
</code></pre></div><h2 id="子查询"><a href="#子查询" class="header-anchor">#</a> 子查询</h2> <ol><li><p>from中的子查询：</p> <p><strong>使用as方法对子查询起别名，并需要对非字段类型表达式起别名。然后使用字段名或者别名作为属性来调用子查询的字段，子查询的字段类型会自动推断。</strong></p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> sub <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> sum<span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span> as <span class="token string">&quot;c1&quot;</span><span class="token punctuation">)</span> from user as <span class="token string">&quot;sub&quot;</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>sub<span class="token punctuation">.</span>id<span class="token punctuation">,</span> sub<span class="token punctuation">.</span>c1<span class="token punctuation">)</span> from sub
</code></pre></div><p>join中的子查询与from的类似，此处不再赘述。</p> <p>可以使用<code>fromLateral</code>、<code>joinLateral</code>等来调用<code>lateral</code>子查询。</p></li> <li><p>表达式中的子查询：</p> <p>只返回一列的子查询可以被用在表达式里，比如：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> sub <span class="token operator">=</span> select <span class="token punctuation">(</span>max<span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> from user

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user where user<span class="token punctuation">.</span>id <span class="token operator">&lt;</span> sub
</code></pre></div><p>支持<code>some</code>、<code>any</code>、<code>exists</code>、<code>notExists</code>、<code>all</code>等子查询谓词：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> sub <span class="token operator">=</span> select <span class="token punctuation">(</span>max<span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> from user

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user where exists<span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
</code></pre></div></li> <li><p>标量子查询</p> <p>只返回一列一行的查询可以被放入select列表中，这被称作标量子查询，我们需要使用<code>toExpr</code>把子查询转换为Expr：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> sub <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span> from user limit <span class="token number">1</span>
<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>sub<span class="token punctuation">.</span>toExpr as <span class="token string">&quot;c1&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>name as <span class="token string">&quot;c2&quot;</span><span class="token punctuation">)</span> from user
</code></pre></div><p><strong>子查询写在表达式的左侧时，也可以使用toExpr方法进行转换</strong></p></li></ol> <h2 id="for-update"><a href="#for-update" class="header-anchor">#</a> for update</h2> <p>使用<code>forUpdate</code>方法来给查询加锁：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select<span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>from<span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>forUpdate
</code></pre></div><p>在sqlserver中会在FROM子句后生成WITH (UPDLOCK)。</p> <h2 id="生成sql"><a href="#生成sql" class="header-anchor">#</a> 生成sql</h2> <p>上文的链式调用，只是构建出了sql语法树，并未真正生成sql语句，我们需要一个终止操作来生成sql：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">given</span> DB <span class="token operator">=</span> DB<span class="token punctuation">.</span>MYSQL

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user orderBy user<span class="token punctuation">.</span>id<span class="token punctuation">.</span>asc limit <span class="token number">10</span>

<span class="token keyword">val</span> sql<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> s<span class="token punctuation">.</span>toSql
<span class="token keyword">val</span> countSql<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> s<span class="token punctuation">.</span>toCountSql
<span class="token keyword">val</span> pageSql<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> s<span class="token punctuation">.</span>toPageSql<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p><code>toSql</code>会一比一的生成sql语句。</p> <p>为了避免性能浪费，<code>toCountSql</code>会拷贝语法树副本，把limit信息和order by信息去掉，并把select列表替换为COUNT(*)，<strong>这适用于查询中没有group by的情况</strong>：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>count<span class="token punctuation">`</span></span>
<span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span>
</code></pre></div><p><code>toPageSql</code>，顾名思义，就是生成分页的查询，第一个参数为每页条数，第二个参数为页码，会依据这两个参数替换语法树副本的信息。</p> <h2 id="union查询"><a href="#union查询" class="header-anchor">#</a> union查询</h2> <p>支持<code>union</code>、<code>unionAll</code>、<code>except</code>、<code>exceptAll</code>、<code>intersect</code>、<code>intersectAll</code>来将两个查询拼接在一起：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s1 <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>name<span class="token punctuation">)</span> from user where user<span class="token punctuation">.</span>id <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">val</span> s2 <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>name<span class="token punctuation">)</span> from user where user<span class="token punctuation">.</span>id <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">2</span>

<span class="token keyword">val</span> union <span class="token operator">=</span> s1 union s2
</code></pre></div><p>用于拼接的查询，select中的字段数目与字段类型必须一致，否则无法通过编译。</p> <h2 id="with查询"><a href="#with查询" class="header-anchor">#</a> with查询</h2> <p>可以使用<code>cte</code>函数来创建一个with查询：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> q <span class="token operator">=</span> cte <span class="token punctuation">{</span>
    <span class="token keyword">val</span> q1 <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>name as <span class="token string">&quot;n1&quot;</span><span class="token punctuation">)</span> from user where user<span class="token punctuation">.</span>id <span class="token operator">&gt;</span> <span class="token number">1</span> as <span class="token string">&quot;q1&quot;</span>
    <span class="token keyword">val</span> q2 <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>name as <span class="token string">&quot;n2&quot;</span><span class="token punctuation">)</span> from user where user<span class="token punctuation">.</span>id <span class="token operator">&gt;</span> <span class="token number">2</span> as <span class="token string">&quot;q2&quot;</span>

    commonTable<span class="token punctuation">(</span>q1<span class="token punctuation">,</span> q2<span class="token punctuation">)</span><span class="token punctuation">.</span>query <span class="token punctuation">{</span>
        select <span class="token punctuation">(</span>q1<span class="token punctuation">.</span>n1<span class="token punctuation">,</span> q2<span class="token punctuation">.</span>n2<span class="token punctuation">)</span> from q1 join q2
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在<code>cte</code>函数中创建公共查询，并使用<code>commonTable</code>将公共查询引入并创建一个with查询表达式，使用<code>query</code>创建最终的查询即可（mysql和pgsql使用递归查询在调用链添加.recursive）。</p> <p><code>cte</code>是一个<strong>上下文函数</strong>，<code>cte</code>中定义的查询在互相引用时，最终生成的sql会把查询别名当做一个表名称使用，而不是嵌套查询本身。</p> <h2 id="values临时表"><a href="#values临时表" class="header-anchor">#</a> values临时表</h2> <p>values临时表最大的用处是被放入union中，我们可以使用<code>Tuple</code>或者<code>List[Tuple]</code>来调用：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> union <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user<span class="token punctuation">.</span>name<span class="token punctuation">)</span> from user union <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">)</span> union List<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;y&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;z&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="获取生成的语法树"><a href="#获取生成的语法树" class="header-anchor">#</a> 获取生成的语法树</h2> <p>上述的查询类型，均支持使用<code>getAst</code>方法来获取查询生成的语法树，方便后续的自定义处理，处理获取到的语法树需要有一些编译原理相关知识，感兴趣的用户可以自行查看<code>easysql.ast</code>包中的语法树定义。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user where user<span class="token punctuation">.</span>id <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">1</span>

<span class="token keyword">val</span> ast<span class="token operator">:</span> SqlQuery <span class="token operator">=</span> s<span class="token punctuation">.</span>getAst
</code></pre></div><p>在处理一些特殊的需求时，可能需要对生成的查询进行深度定制，这种场景下，则可以在上面生成的语法树基础上进行二次处理。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/easysql-doc/expr/" class="prev">
        表达式
      </a></span> <span class="next"><a href="/easysql-doc/query/">
        集合函数风格查询
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/easysql-doc/assets/js/app.043c89df.js" defer></script><script src="/easysql-doc/assets/js/2.ebde4dba.js" defer></script><script src="/easysql-doc/assets/js/16.b981116c.js" defer></script>
  </body>
</html>
