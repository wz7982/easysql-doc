<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>表达式 | easysql</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="类型安全的查询构造器，orm">
    
    <link rel="preload" href="/easysql-doc/assets/css/0.styles.e413b544.css" as="style"><link rel="preload" href="/easysql-doc/assets/js/app.043c89df.js" as="script"><link rel="preload" href="/easysql-doc/assets/js/2.ebde4dba.js" as="script"><link rel="preload" href="/easysql-doc/assets/js/9.27ab6d13.js" as="script"><link rel="prefetch" href="/easysql-doc/assets/js/10.755206bb.js"><link rel="prefetch" href="/easysql-doc/assets/js/11.108365c7.js"><link rel="prefetch" href="/easysql-doc/assets/js/12.1019e624.js"><link rel="prefetch" href="/easysql-doc/assets/js/13.eaad68f3.js"><link rel="prefetch" href="/easysql-doc/assets/js/14.ebdb112e.js"><link rel="prefetch" href="/easysql-doc/assets/js/15.16c963a1.js"><link rel="prefetch" href="/easysql-doc/assets/js/16.b981116c.js"><link rel="prefetch" href="/easysql-doc/assets/js/17.8b6320d9.js"><link rel="prefetch" href="/easysql-doc/assets/js/3.8dfc125c.js"><link rel="prefetch" href="/easysql-doc/assets/js/4.13b745f6.js"><link rel="prefetch" href="/easysql-doc/assets/js/5.54501c54.js"><link rel="prefetch" href="/easysql-doc/assets/js/6.45f8a5ad.js"><link rel="prefetch" href="/easysql-doc/assets/js/7.4e2227f1.js"><link rel="prefetch" href="/easysql-doc/assets/js/8.fc49f0b8.js">
    <link rel="stylesheet" href="/easysql-doc/assets/css/0.styles.e413b544.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/easysql-doc/" class="home-link router-link-active"><!----> <span class="site-name">easysql</span></a> <div class="links"><!----> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/easysql-doc/" aria-current="page" class="sidebar-link">概述</a></li><li><a href="/easysql-doc/introduction/" class="sidebar-link">入门</a></li><li><a href="/easysql-doc/metadata/" class="sidebar-link">元数据配置</a></li><li><a href="/easysql-doc/expr/" aria-current="page" class="active sidebar-link">表达式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/easysql-doc/expr/#字段" class="sidebar-link">字段</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/expr/#别名" class="sidebar-link">别名</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/expr/#值" class="sidebar-link">值</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/expr/#逻辑运算与关系运算" class="sidebar-link">逻辑运算与关系运算</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/expr/#数学运算" class="sidebar-link">数学运算</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/expr/#聚合函数" class="sidebar-link">聚合函数</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/expr/#普通函数" class="sidebar-link">普通函数</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/expr/#窗口函数" class="sidebar-link">窗口函数</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/expr/#case-when" class="sidebar-link">case when</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/expr/#cast类型转换" class="sidebar-link">cast类型转换</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/expr/#json操作" class="sidebar-link">json操作</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/expr/#动态表达式" class="sidebar-link">动态表达式</a></li><li class="sidebar-sub-header"><a href="/easysql-doc/expr/#日期间隔表达式" class="sidebar-link">日期间隔表达式</a></li></ul></li><li><a href="/easysql-doc/select/" class="sidebar-link">查询</a></li><li><a href="/easysql-doc/query/" class="sidebar-link">集合函数风格查询</a></li><li><a href="/easysql-doc/jpa/" class="sidebar-link">JPA风格查询</a></li><li><a href="/easysql-doc/update/" class="sidebar-link">增删改</a></li><li><a href="/easysql-doc/native-sql/" class="sidebar-link">原生sql</a></li><li><a href="/easysql-doc/database/" class="sidebar-link">数据库交互</a></li><li><a href="/easysql-doc/nosql/" class="sidebar-link">nosql支持</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="表达式"><a href="#表达式" class="header-anchor">#</a> 表达式</h1> <p>在开始编写查询之前，我们最好对sql的表达式有一些了解。</p> <p>easysql中封装了sql的语法树，sql的表达式拥有共同的父类<code>Expr</code>，而大部分表达式，它们也接收<code>Expr</code>类型的参数，来组合成新的表达式。</p> <p>因此，easysql拥有强大的抽象能力，通过表达式的组合，我们几乎可以写出任何sql中合法的语句，而无需使用容易出错的原生sql。</p> <h2 id="字段"><a href="#字段" class="header-anchor">#</a> 字段</h2> <p>字段是最基本的表达式，上文中，我们使用<code>asTable</code>创建的元数据对象，它的属性就是字段类型的表达式。</p> <p>有了字段表达式，我们就可以写这样的查询：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span> from user
</code></pre></div><p><code>select</code>传入使用<code>asTable</code>产生的对象的话，可以在查询中自动展开全部字段：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user
</code></pre></div><p>如果你喜欢，也可以在<code>asTable</code>生成的对象后面添加<code>*</code>，使其更接近原生sql，这并不会改变查询的意义：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>*<span class="token punctuation">)</span> from user
</code></pre></div><p>有些应用里，表是运行期动态创建的，没法对数据进行预先建模，这时候可以使用<code>col</code>方法来创建一个动态字段；</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">&quot;t.id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> from table<span class="token punctuation">(</span><span class="token string">&quot;t&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><code>col</code>可以携带类型参数，我们可以精确指定字段类型：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> idCol <span class="token operator">=</span> col<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;t.id&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>idCol<span class="token punctuation">)</span> from table<span class="token punctuation">(</span><span class="token string">&quot;t&quot;</span><span class="token punctuation">)</span> where idCol <span class="token operator">&gt;</span> <span class="token number">1</span>
</code></pre></div><blockquote><p>在非常动态的查询中（比如编译期我们对数据的模型一无所知的情况下），也可以不给col添加类型参数，而是导入import easysql.dsl.unsafeOperator。这样就会放弃类型安全，但是会让动态查询更方便，不过在大多数可以配置元数据的场景中，不推荐这样做。</p></blockquote> <p>库内置了一个名为<code>*</code>的方法，用来产生一个字段通配符：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>
<span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span>AllColumn<span class="token punctuation">.</span>`<span class="token operator">*</span>`

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> from table<span class="token punctuation">(</span><span class="token string">&quot;t&quot;</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>同样主要用于非常动态的查询</p></blockquote> <h2 id="别名"><a href="#别名" class="header-anchor">#</a> 别名</h2> <p><code>Expr</code>表达式可以使用<code>as</code>方法，用来起别名：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id as <span class="token string">&quot;c1&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>name as <span class="token string">&quot;c2&quot;</span><span class="token punctuation">)</span> from user
</code></pre></div><p><code>as</code>方法可以推广到后续介绍的任何sql表达式类型，后文便不再赘述。</p> <p>值得一提的是：<code>as</code>方法使用了一种名为<code>refinement type</code>的手段达到类型安全，<code>as</code>的参数如果为<strong>空字符串</strong>，则不能通过编译：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token comment">// 编译错误</span>
<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id as <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> from user
</code></pre></div><p>如果别名需要运行期动态确定，可以使用<code>unsafeAs</code>方法。</p> <h2 id="值"><a href="#值" class="header-anchor">#</a> 值</h2> <p>有一些需求中，可能需要把值作为查询结果集的一列，比如：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token number">1</span> <span class="token keyword">AS</span> <span class="token string">&quot;col1&quot;</span>
</code></pre></div><p>为了实现这个需求，我们需要<code>import easysql.dsl.Expr.given</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>
<span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span>Expr<span class="token punctuation">.</span><span class="token keyword">given</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span><span class="token number">1</span> as <span class="token string">&quot;col1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span> as <span class="token string">&quot;col2&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>如果有一些特殊的需求，比如下文会介绍的自定义sql函数，我们也可以使用<code>value()</code>将值包装起来，生成一个值表达式：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> expr<span class="token operator">:</span> Expr<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="逻辑运算与关系运算"><a href="#逻辑运算与关系运算" class="header-anchor">#</a> 逻辑运算与关系运算</h2> <p>除开字段和常量之外，最常见的表达式就是逻辑运算与关系运算构成的表达式。它常被用于sql的where条件中。</p> <p>支持的符号运算符如下：</p> <table><thead><tr><th style="text-align:center;">运算符名称</th> <th style="text-align:center;">对应sql运算符</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>===</code></td> <td style="text-align:center;"><code>=</code></td></tr> <tr><td style="text-align:center;"><code>&lt;&gt;</code></td> <td style="text-align:center;"><code>&lt;&gt;</code></td></tr> <tr><td style="text-align:center;"><code>&gt;</code></td> <td style="text-align:center;"><code>&gt;</code></td></tr> <tr><td style="text-align:center;"><code>&gt;=</code></td> <td style="text-align:center;"><code>&gt;=</code></td></tr> <tr><td style="text-align:center;"><code>&lt;</code></td> <td style="text-align:center;"><code>&lt;</code></td></tr> <tr><td style="text-align:center;"><code>&lt;=</code></td> <td style="text-align:center;"><code>&lt;=</code></td></tr> <tr><td style="text-align:center;"><code>&amp;&amp;</code></td> <td style="text-align:center;"><code>AND</code></td></tr> <tr><td style="text-align:center;"><code>||</code></td> <td style="text-align:center;"><code>OR</code></td></tr> <tr><td style="text-align:center;"><code>^</code></td> <td style="text-align:center;"><code>XOR</code></td></tr></tbody></table> <p>使用这些运算符就如同语言内置的一样：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> id <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">val</span> name <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span>
<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user where user<span class="token punctuation">.</span>id <span class="token operator">&gt;</span> id <span class="token operator">&amp;&amp;</span> user<span class="token punctuation">.</span>name <span class="token operator">==</span><span class="token operator">=</span> name 
</code></pre></div><p>二元运算的右侧，不仅可以是值，也可以是其他表达式，比如做join语句的连接条件：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">,</span> post<span class="token punctuation">)</span> from user join post on user<span class="token punctuation">.</span>id <span class="token operator">==</span><span class="token operator">=</span> post<span class="token punctuation">.</span>userId
</code></pre></div><p>当然，运算符的左侧也可以是普通的值，easysql使用<code>typeclass（类型类）</code>对运算符进行扩展，这种情况我们需要<code>import easysql.dsl.Expr.given</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>
<span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span>Expr<span class="token punctuation">.</span><span class="token keyword">given</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user where <span class="token number">1</span> <span class="token operator">&lt;</span> user<span class="token punctuation">.</span>id
</code></pre></div><blockquote><p><code>===</code>与<code>&lt;&gt;</code>在与<code>None</code>比较时，生成的sql为<code>IS NULL</code>与<code>IS NOT NULL。</code></p></blockquote> <blockquote><p>字符串也可以和<code>Date</code>类型的表达式进行比较。</p></blockquote> <p>除开这些符号组成的运算，还支持下面这些非符号运算符。由于这些运算符没有编译器控制的优先级，所以更推荐使用<code>.</code>加上方法名的方式调用，而非中缀的方式：</p> <table><thead><tr><th style="text-align:center;">运算符名称</th> <th style="text-align:center;">对应sql运算符</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>in</code></td> <td style="text-align:center;"><code>IN</code></td></tr> <tr><td style="text-align:center;"><code>notIn</code></td> <td style="text-align:center;"><code>NOT IN</code></td></tr> <tr><td style="text-align:center;"><code>between</code></td> <td style="text-align:center;"><code>BETWEEN</code></td></tr> <tr><td style="text-align:center;"><code>notBetween</code></td> <td style="text-align:center;"><code>NOT BETWEEN</code></td></tr> <tr><td style="text-align:center;"><code>like</code></td> <td style="text-align:center;"><code>LIKE</code></td></tr> <tr><td style="text-align:center;"><code>notLike</code></td> <td style="text-align:center;"><code>NOT LIKE</code></td></tr></tbody></table> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user where user<span class="token punctuation">.</span>id<span class="token punctuation">.</span>between<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">||</span> user<span class="token punctuation">.</span>name<span class="token punctuation">.</span>in<span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;y&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> s1 <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user where user<span class="token punctuation">.</span>name<span class="token punctuation">.</span>like<span class="token punctuation">(</span><span class="token string">&quot;x%&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>这些运算符的抽象能力也一样强大：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>
<span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span>Expr<span class="token punctuation">.</span><span class="token keyword">given</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user where user<span class="token punctuation">.</span>id<span class="token punctuation">.</span>in<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>id<span class="token punctuation">)</span>

<span class="token keyword">val</span> s1 <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user where <span class="token number">1.</span>in<span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
</code></pre></div><blockquote><p>in运算符为了避免生成的查询语法错误，如果in后面的参数是空列表，那么会把此部分的条件改写为FALSE，notIn空列表时会把此部分改写为TRUE。</p></blockquote> <p>此外，还支持一元逻辑运算<code>!</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">)</span> from user where <span class="token operator">!</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>生成的sql为<code>NOT()</code>。</p></blockquote> <h2 id="数学运算"><a href="#数学运算" class="header-anchor">#</a> 数学运算</h2> <p>除开上面的逻辑运算外，还支持<code>+</code>、<code>-</code>、<code>*</code>、<code>/</code>、<code>%</code>五个数学运算：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> from user where user<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;</span> <span class="token number">5</span>
</code></pre></div><p>普通的值也可以写在表达式左侧。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> user<span class="token punctuation">.</span>id<span class="token punctuation">)</span> from user where <span class="token number">1</span> <span class="token operator">+</span> user<span class="token punctuation">.</span>id <span class="token operator">&gt;</span> <span class="token number">5</span>
</code></pre></div><h2 id="聚合函数"><a href="#聚合函数" class="header-anchor">#</a> 聚合函数</h2> <p>库内置了几个常用的标准聚合函数：<code>count</code>、<code>countDistinct</code>、<code>max</code>、<code>min</code>、<code>sum</code>、<code>avg</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span> as <span class="token string">&quot;col1&quot;</span><span class="token punctuation">,</span> sum<span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span> as <span class="token string">&quot;col2&quot;</span><span class="token punctuation">)</span> from user
</code></pre></div><p>聚合函数也可以成为其他表达式的一部分：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> avg<span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">+</span> sum<span class="token punctuation">(</span>user<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> as <span class="token string">&quot;col1&quot;</span><span class="token punctuation">)</span> from user
</code></pre></div><p>有趣的是，上面介绍的用于创建字段通配符的<code>*</code>，也是<code>Expr</code>的子类，所以我们可以像真正的sql一样写：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>
<span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span>AllColumn<span class="token punctuation">.</span>`<span class="token operator">*</span>`

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>count<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> from user
</code></pre></div><p>您也可以从此处看出easysql表达式组合的威力。</p> <h2 id="普通函数"><a href="#普通函数" class="header-anchor">#</a> 普通函数</h2> <p>由于各种数据库的函数差异极大，easysql没有内置普通的函数，但是我们可以通过<code>Expr</code>的子类<code>FuncExpr</code>来定义需要的sql函数。</p> <p><code>FuncExpr</code>的定义如下：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">case</span> <span class="token keyword">class</span> FuncExpr<span class="token punctuation">[</span>T <span class="token operator">&lt;</span><span class="token operator">:</span> SqlDataType<span class="token punctuation">]</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> args<span class="token operator">:</span> List<span class="token punctuation">[</span>Expr<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Expr<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>其中，类型参数<code>T</code>是sql函数的返回值类型，<code>name</code>是函数名称，<code>args</code>是参数列表。</p> <p>以mysql的LEFT函数为例，LEFT接收两个参数，第一个参数是一个String类型的表达式，第二个参数是一个Int值，我们可以这样来封装：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">def</span> left<span class="token punctuation">(</span>expr<span class="token operator">:</span> Expr<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">,</span> n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> FuncExpr<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;LEFT&quot;</span><span class="token punctuation">,</span> List<span class="token punctuation">(</span>expr<span class="token punctuation">,</span> value<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>然后这个函数就可以带入进查询了：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>left<span class="token punctuation">(</span>user<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> as <span class="token string">&quot;left&quot;</span><span class="token punctuation">)</span> from user
</code></pre></div><p>当然，与其他表达式一样，函数也可以嵌套调用：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>left<span class="token punctuation">(</span>left<span class="token punctuation">(</span>user<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> as <span class="token string">&quot;left&quot;</span><span class="token punctuation">)</span> from user
</code></pre></div><p>对于聚合函数，也提供了类似的封装结构：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">case</span> <span class="token keyword">class</span> AggExpr<span class="token punctuation">[</span>T <span class="token operator">&lt;</span><span class="token operator">:</span> SqlDataType<span class="token punctuation">]</span><span class="token punctuation">(</span>
    name<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span>
    args<span class="token operator">:</span> List<span class="token punctuation">[</span>Expr<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    distinct<span class="token operator">:</span> <span class="token builtin">Boolean</span><span class="token punctuation">,</span>
    attributes<span class="token operator">:</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Expr<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    orderBy<span class="token operator">:</span> List<span class="token punctuation">[</span>OrderBy<span class="token punctuation">]</span>
<span class="token punctuation">)</span> <span class="token keyword">extends</span> Expr<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>有需要的话，也可以用来封装聚合函数来带入到查询里。</p> <h2 id="窗口函数"><a href="#窗口函数" class="header-anchor">#</a> 窗口函数</h2> <p>内置了三个标准的窗口函数使用的聚合函数：<code>rank</code>, <code>denseRank</code>, <code>rowNumber</code>。</p> <p>在聚合函数后面调用<code>.over</code>，来创建一个窗口函数，然后通过<code>partitionBy</code>和<code>orderBy</code>来构建一个窗口：</p> <div class="language-scala extra-class"><pre class="language-scala"><code>select <span class="token punctuation">(</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over partitionBy user<span class="token punctuation">.</span>id orderBy user<span class="token punctuation">.</span>name<span class="token punctuation">.</span>asc as <span class="token string">&quot;over&quot;</span><span class="token punctuation">)</span> from user
</code></pre></div><p>这会产生如下的查询：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> <span class="token keyword">user</span><span class="token punctuation">.</span>id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">user</span><span class="token punctuation">.</span>user_name <span class="token keyword">ASC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">over</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span>
</code></pre></div><p><code>partitionBy()</code>接收若干个表达式类型</p> <p><code>orderBy()</code>接收若干个排序列，在表达式类型之后调用<code>.asc</code>或<code>.desc</code>来生成排序规则。</p> <blockquote><p>使用窗口函数时需要注意数据库本身是否支持（比如mysql8.0以下版本不支持窗口函数功能）。</p></blockquote> <p>我们也可以在窗口函数中使用<code>rowsBetween</code>或<code>rangeBetween</code>筛选行，比如：</p> <div class="language-scala extra-class"><pre class="language-scala"><code>select <span class="token punctuation">(</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over partitionBy user<span class="token punctuation">.</span>id orderBy user<span class="token punctuation">.</span>name<span class="token punctuation">.</span>asc rowsBetween<span class="token punctuation">(</span><span class="token number">10.</span>preceding<span class="token punctuation">,</span> currentRow<span class="token punctuation">)</span> as <span class="token string">&quot;over&quot;</span><span class="token punctuation">)</span> from user
</code></pre></div><p><code>rowsBetween</code>或<code>rangeBetween</code>中的参数可以是<code>unboundedPreceding</code>、<code>unboundedFollowing</code>、<code>currentRow</code>以及<code>Int</code>的扩展方法<code>preceding</code>、<code>following</code>中的任意两项。</p> <h2 id="case-when"><a href="#case-when" class="header-anchor">#</a> case when</h2> <p>使用<code>caseWhen()</code>方法创建一个条件表达式，由于此表达式用到的关键字<code>case</code>、<code>then</code>、<code>else</code>等都是Scala3的关键字，所以只能使用中缀函数<code>thenIs</code>与<code>elseIs</code>来生成一个条件表达式：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> c <span class="token operator">=</span> caseWhen<span class="token punctuation">(</span>user<span class="token punctuation">.</span>state <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">1</span> thenIs <span class="token string">&quot;正常&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>gender <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">0</span> thenIs <span class="token string">&quot;删除&quot;</span><span class="token punctuation">)</span> elseIs <span class="token string">&quot;其他&quot;</span>

<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>c as <span class="token string">&quot;state&quot;</span><span class="token punctuation">)</span> from user
</code></pre></div><p>这会产生下面的查询：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">CASE</span> 
		<span class="token keyword">WHEN</span> <span class="token keyword">user</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token string">'正常'</span>
		<span class="token keyword">WHEN</span> <span class="token keyword">user</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">THEN</span> <span class="token string">'删除'</span>
		<span class="token keyword">ELSE</span> <span class="token string">'其他'</span>
	<span class="token keyword">END</span> <span class="token keyword">AS</span> state
<span class="token keyword">FROM</span> <span class="token keyword">user</span>
</code></pre></div><p>case when表达式也可以传入聚合函数中：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> c <span class="token operator">=</span> caseWhen<span class="token punctuation">(</span>user<span class="token punctuation">.</span>state <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">1</span> thenIs user<span class="token punctuation">.</span>state<span class="token punctuation">)</span> elseIs None

<span class="token keyword">val</span> select <span class="token operator">=</span> select <span class="token punctuation">(</span>count<span class="token punctuation">(</span>c<span class="token punctuation">)</span> as <span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span> from user
</code></pre></div><h2 id="cast类型转换"><a href="#cast类型转换" class="header-anchor">#</a> cast类型转换</h2> <p>使用<code>cast</code>方法生成一个cast表达式用于数据库类型转换。</p> <p>第一个参数为待转换的表达式；</p> <p>第二个参数为String，为想转换的数据类型。</p> <p>比如：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> select <span class="token operator">=</span> select <span class="token punctuation">(</span>cast<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">&quot;CHAR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> from user
</code></pre></div><p>这会产生下面的查询：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> CAST<span class="token punctuation">(</span><span class="token keyword">user</span><span class="token punctuation">.</span>id <span class="token keyword">AS</span> <span class="token keyword">CHAR</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span>
</code></pre></div><h2 id="json操作"><a href="#json操作" class="header-anchor">#</a> json操作</h2> <p>支持<code>-&gt;</code>和<code>-&gt;&gt;</code>两个json操作符，语义与原生sql一致。</p> <p>由于<code>-&gt;</code>与标准库构建二元组的函数名相同，为了避免编译错误，我们需要导入<code>easysql.dsl.Expr.given</code>。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>
<span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span>Expr<span class="token punctuation">.</span><span class="token keyword">given</span>

<span class="token comment">// mysql</span>
<span class="token keyword">val</span> s1 <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user<span class="token punctuation">.</span>jsonCol <span class="token operator">-&gt;</span><span class="token operator">&gt;</span> <span class="token string">&quot;$.x.y&quot;</span><span class="token punctuation">)</span> from user where user<span class="token punctuation">.</span>jsonCol <span class="token operator">-&gt;</span><span class="token operator">&gt;</span> <span class="token string">&quot;$.x.y&quot;</span> <span class="token operator">==</span><span class="token operator">=</span> <span class="token string">&quot;a&quot;</span>

<span class="token comment">// pgsql</span>
<span class="token keyword">val</span> s2 <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user<span class="token punctuation">.</span>jsonCol <span class="token operator">-&gt;</span> <span class="token string">&quot;x&quot;</span> <span class="token operator">-&gt;</span><span class="token operator">&gt;</span> <span class="token string">&quot;y&quot;</span><span class="token punctuation">)</span> from user where user<span class="token punctuation">.</span>jsonCol <span class="token operator">-&gt;</span> <span class="token string">&quot;x&quot;</span> <span class="token operator">-&gt;</span><span class="token operator">&gt;</span> <span class="token string">&quot;y&quot;</span> <span class="token operator">==</span><span class="token operator">=</span> <span class="token string">&quot;a&quot;</span>
</code></pre></div><p>如需使用json操作函数的话，可以参考上文sql函数部分的说明进行封装。</p> <p>json操作会在数据库查询后被映射到String类型。</p> <h2 id="动态表达式"><a href="#动态表达式" class="header-anchor">#</a> 动态表达式</h2> <p>有些需要动态查询的场景中（比如报表平台），查询的表达式可能是由用户动态填写的，如果想对填写的内容进行解析，可能需要开发者有一定的编译原理功底，不过，easysql支持将普通的sql字符串当做表达式的一部分，即使开发者没有这种功底，也可以方便地解析用户创建的动态表达式。</p> <p>解析一个动态的表达式，可以使用上文字段部分介绍的<code>col</code>方法，<code>col</code>不仅可以处理简单的字段名，也可以处理更复杂的表达式，并将其代入查询中：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> dynExpr1 <span class="token operator">=</span> col<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;case when user.id = 1 then 'a' when user.id = 2 then 'b' else 'c'&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> dynExpr2 <span class="token operator">=</span> col<span class="token punctuation">[</span>Boolan<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;user.id in (1, 2, 3) or user.name is not null&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">val</span> s <span class="token operator">=</span> select <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> user<span class="token punctuation">.</span>name<span class="token punctuation">,</span> dynExpr1 as <span class="token string">&quot;col3&quot;</span><span class="token punctuation">)</span> from user where dynExpr2 <span class="token operator">&amp;&amp;</span> user<span class="token punctuation">.</span>createTime <span class="token operator">&gt;</span> <span class="token string">&quot;2023-01-01&quot;</span>
</code></pre></div><p>在使用<code>col</code>创建动态表达式时，会对传入的sql表达式进行解析，如果其中有语法错误，则会抛出<code>easysql.parser.ParseException</code>异常，并说明错误位置。</p> <p>动态表达式支持子查询谓词和窗口函数在内的大多数sql表达式。</p> <h2 id="日期间隔表达式"><a href="#日期间隔表达式" class="header-anchor">#</a> 日期间隔表达式</h2> <p>我们可以使用<code>interval</code>方法生成日期间隔表达式（<strong>目前仅支持生成MySQL和PostgreSQL方言</strong>）：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">easysql<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token comment">// mysql</span>
<span class="token keyword">val</span> s1 <span class="token operator">=</span> select <span class="token punctuation">(</span><span class="token string">&quot;2023-01-01 00:00:00&quot;</span> <span class="token operator">-</span> interval<span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> day<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// pgsql</span>
<span class="token keyword">val</span> s2 <span class="token operator">=</span> select <span class="token punctuation">(</span><span class="token string">&quot;2023-01-01 00:00:00&quot;</span> <span class="token operator">-</span> interval<span class="token punctuation">(</span><span class="token string">&quot;1 days&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/easysql-doc/metadata/" class="prev">
        元数据配置
      </a></span> <span class="next"><a href="/easysql-doc/select/">
        查询
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/easysql-doc/assets/js/app.043c89df.js" defer></script><script src="/easysql-doc/assets/js/2.ebde4dba.js" defer></script><script src="/easysql-doc/assets/js/9.27ab6d13.js" defer></script>
  </body>
</html>
